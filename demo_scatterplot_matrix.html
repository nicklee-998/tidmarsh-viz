<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
	<link rel="stylesheet" type="text/css" href="./scripts2/css/scatter_plot_matrix.css"/>
	<link rel="stylesheet" type="text/css" href="./css/datepicker.css"/>
	<style type="text/css">

		html {
			background-color: rgba(32, 36, 40, 1);
		}

		#datepicker_scatterplot {
			position: absolute;
		}

	</style>
</head>
<body>
<div id="state"></div>
<div id="scatterplot_cont"></div>
<div id="scatterplot_time"></div>
<div id="scatterplot_menu"></div>
<div id="datepicker_scatterplot"></div>

<script src="./libs/jquery-1.11.1.min.js"></script>
<script src="./libs/jquery-ui.js"></script>
<script src="./libs/tiny-pubsub.js"></script>
<script src="./libs/d3.js"></script>
<script src="./libs/stats.min.js"></script>
<script src="./libs/hexbin/hexbin.js"></script>
<script src="scripts2/view/ScatterPlotGraph.js"></script>
<script src="scripts2/view/ScatterPlotTimeGraph.js"></script>
<script src="scripts2/controllers/UiScatterplotMatrix.js"></script>
<script src="scripts2/global/CustomEvent.js"></script>
<script>

	const SITE_URL = "http://chain-api.media.mit.edu/devices/?site_id=7";

	var devices;
	var scatterGraph, scatterTimeGraph;
	var menu;

	var stats;

	$(document).ready(function() {

		stats = new Stats();
		stats.setMode(0); // 0: fps, 1: ms

		// align top-left
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.left = '0px';
		stats.domElement.style.top = '0px';
		document.body.appendChild( stats.domElement );

		requestAnimationFrame( update );


		menu = new UiScatterplotMatrix("scatterplot_menu");

		jQuery.subscribe(SCATTER_PLOT_SELECTED, function(e, d) {
			scatterTimeGraph.draw(d.tlist);
		});
		jQuery.subscribe(SCATTER_PLOT_PREV, function() {
			putBackTime(24);
		});
		jQuery.subscribe(SCATTER_PLOT_NEXT, function() {
			putForwardTime(24);
		});
		jQuery.subscribe(SCATTER_PLOT_PREV_FAST, function() {
			putBackTime(240);
		});
		jQuery.subscribe(SCATTER_PLOT_NEXT_FAST, function() {
			putForwardTime(240);
		});
		jQuery.subscribe(SCATTER_PLOT_DATE_SELECTED, function(e, d) {
			scatterGraph.resetDate(d.start, d.end);
		});

		$.getJSON(SITE_URL, function(dat) {

			// TODO: That's use a little trick way to get all sensors from on request, maybe change the way in future...
			var url = SITE_URL + '&limit=' + dat.totalCount + '&offset=0';
			$.getJSON(url, function(dat2) {
				devices = dat2["_links"]["items"];

				scatterGraph = new ScatterPlotGraph();
				scatterGraph.initDataset(devices);
				scatterTimeGraph = new ScatterPlotTimeGraph("scatterplot_time");
				scatterTimeGraph.show();
				menu.resetDate(scatterGraph._start_time, scatterGraph._end_time);
				menu.show();
			});
		});
	});

	function putBackTime(hours)
	{
		var date = new Date(scatterGraph._start_time.toString());
		date.setHours(date.getHours() - hours);

		if(date < scatterGraph.dataHead) {
			return;
		}

		scatterGraph._start_time.setHours(scatterGraph._start_time.getHours() - hours);
		scatterGraph._end_time.setHours(scatterGraph._end_time.getHours() - hours);

		menu.resetDate(scatterGraph._start_time, scatterGraph._end_time);
		scatterGraph.resetDate(scatterGraph._start_time, scatterGraph._end_time);
	}

	function putForwardTime(hours)
	{
		var date = new Date(scatterGraph._end_time.toString());
		date.setHours(date.getHours() + hours);

		if(date > scatterGraph.dataTrail) {
			return;
		}

		scatterGraph._start_time.setHours(scatterGraph._start_time.getHours() + hours);
		scatterGraph._end_time.setHours(scatterGraph._end_time.getHours() + hours);

		menu.resetDate(scatterGraph._start_time, scatterGraph._end_time);
		scatterGraph.resetDate(scatterGraph._start_time, scatterGraph._end_time);
	}

	/////////////////////////////////////////////
	// FOR FPS
	/////////////////////////////////////////////
	var update = function () {

		stats.begin();

		// monitored code goes here

		stats.end();

		requestAnimationFrame( update );

	};

	/////////////////////////////////////////////
	// FOR TEST
	/////////////////////////////////////////////
	function onKeyboardDown()
	{
//		// 返回键退出
		if(d3.event.keyCode == 37) 		// LEFT
		{
			scatterGraph._start_time.setHours(scatterGraph._start_time.getHours() - 240);
			scatterGraph._end_time.setHours(scatterGraph._end_time.getHours() - 240);

			console.log(graph._start_time.toLocaleDateString() + " - " + scatterGraph._end_time.toLocaleDateString());
			scatterGraph.resetDate(scatterGraph._start_time, scatterGraph._end_time);
		}
		else if(d3.event.keyCode == 39) 	// RIGHT
		{
			scatterGraph._start_time.setHours(scatterGraph._start_time.getHours() + 240);
			scatterGraph._end_time.setHours(scatterGraph._end_time.getHours() + 240);

			console.log(scatterGraph._start_time.toLocaleDateString() + " - " + scatterGraph._end_time.toLocaleDateString());
			scatterGraph.resetDate(scatterGraph._start_time, scatterGraph._end_time);
		}
		else if(d3.event.keyCode == 38)
		{
			scatterGraph.highlightDevices(["0x8114"]);
		}
	}
	d3.select("body").on("keydown", onKeyboardDown);

</script>
</body>
</html>
